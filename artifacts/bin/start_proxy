#!/bin/bash
set -eo pipefail

dh_parameters_path=/etc/ssl/private/dhparam.pem

# Default values
default_http_port=80
default_https_port=443
default_ssl_cert_filename=cert.pem
default_ssl_cert_key_filename=key.pem

# Use default values rather than ENV vars, if not present
export HTTP_PORT=${HTTP_PORT:-$default_http_port}
export HTTPS_PORT=${HTTPS_PORT:-$default_https_port}
export SSL_CERT_FILENAME=${SSL_CERT_FILENAME:-$default_ssl_cert_filename}
export SSL_CERT_KEY_FILENAME=${SSL_CERT_KEY_FILENAME:-$default_ssl_cert_key_filename}


# Make sure the DH parameters and certificate files are accessible
if [[ ! -f ${dh_parameters_path} ]]; then
  cat <<EOF
ERROR: Diffie Hellman parameters not found at ${dh_parameters_path}.
Please generate DH parameters and mount them at the aforementioned path.
e.g. openssl dhparam -out /path/to/mounted/directory/dhparam.pem 4096
EOF
  exit 1
fi

declare -a required_cert_files=(${SSL_CERT_FILENAME} ${SSL_CERT_KEY_FILENAME})

for file in "${required_cert_files[@]}"
do
  cert_base_dir=/etc/ssl/private

   if [[ ! -f "${cert_base_dir}/${file}" ]]; then
    cat <<EOF
    ERROR: ${file} does not exist in ${cert_base_dir}.
    Please make sure this file exists and is in a directory that is mounted to the aforementioned path.
EOF
    exit 1
   fi
done

# Make sure that the required environment variables are set
declare -a required_env_variables=("SERVER_NAME" "PROXIED_APP_URL")

for env_var in "${required_env_variables[@]}"; do  
  if [[ -z "${!env_var}" ]]; then
    echo "ERROR: The '${env_var}' environment variable must be set."
    exit 1
  fi
done


# Deploy config
envsubst '\$HTTP_PORT \$HTTPS_PORT \$SERVER_NAME \$PROXIED_APP_URL \$SSL_CERT_FILENAME \$SSL_CERT_KEY_FILENAME' < /etc/nginx/conf.d/nginx.template > /etc/nginx/conf.d/default.conf

# Run NGinx
exec nginx -g 'daemon off;'